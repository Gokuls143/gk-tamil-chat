<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Community Chat</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    
    /* Safe area bars for mobile browsers */
    .top-safe-bar{position:fixed;top:0;left:0;right:0;height:env(safe-area-inset-top, 0px);background:#0b1220;z-index:9999;min-height:0;display:none}
    .bottom-safe-bar{position:fixed;bottom:0;left:0;right:0;height:env(safe-area-inset-bottom, 0px);background:#0b1220;z-index:9999;min-height:0;display:none}
    
    /* Adjust body to account for safe areas */
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:#0b1220;
      color:#e6eef8;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
      padding-top:max(20px, env(safe-area-inset-top));
      padding-bottom:max(20px, env(safe-area-inset-bottom));
    }
    
    .chat-container{width:1260px;height:600px;display:flex;flex-direction:column;background:#0b1220;border:1px solid rgba(255,255,255,0.08);border-radius:12px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    
    /* Header Styles */
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#0f172a;border-bottom:1px solid rgba(255,255,255,0.08);flex-shrink:0;min-height:60px;height:60px}
    .brand{display:flex;gap:8px;align-items:center;flex:1;min-width:0}
    .brand a{color:#fff;text-decoration:none;font-weight:700;display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;transition:background 0.2s;white-space:nowrap}
    .brand a:hover{background:rgba(255,255,255,0.06)}
    .brand svg{width:18px;height:18px;fill:currentColor;flex-shrink:0}
    .brand-title{font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,#4f46e5,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;white-space:nowrap}
    .header-actions{display:flex;align-items:center;gap:10px;flex-shrink:0}
    
    /* Profile Menu */
    .profile-menu{position:relative}
    .profile-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#06b6d4);border:2px solid rgba(255,255,255,0.1);cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;transition:transform 0.2s;overflow:hidden;flex-shrink:0}
    .profile-btn:hover{transform:scale(1.05)}
    .profile-btn img{width:100%;height:100%;object-fit:cover}
    .dropdown{position:absolute;right:0;top:50px;background:#0e1627;border:1px solid rgba(255,255,255,0.1);border-radius:10px;min-width:200px;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:none;z-index:1000}
    .dropdown.show{display:block}
    .dropdown-header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.08)}
    .dropdown-header .username{font-weight:600;font-size:.95rem;word-break:break-word}
    .dropdown-header .email{font-size:.8rem;color:#94a3b8;margin-top:4px}
    .dropdown-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background 0.2s;border:0;background:transparent;width:100%;text-align:left;color:#e6eef8;font-size:.9rem}
    .dropdown-item:hover{background:rgba(255,255,255,0.06)}
    .dropdown-item svg{width:16px;height:16px;fill:currentColor}
    .dropdown-divider{height:1px;background:rgba(255,255,255,0.08);margin:4px 0}
    
    /* Main Layout */
    .main-container{flex:1;display:flex;overflow:hidden;position:relative;min-height:0}
    .chat-section{flex:1;display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.08);min-height:0;min-width:0}
    
    /* Sidebar */
    .sidebar{width:280px;background:#0e1627;display:flex;flex-direction:column;overflow:hidden;border-left:1px solid rgba(255,255,255,0.08);flex-shrink:0}
    .sidebar-header{padding:12px 16px;background:#0f172a;border-bottom:1px solid rgba(255,255,255,0.08);font-weight:600;font-size:.95rem;display:flex;justify-content:space-between;align-items:center;min-height:48px}
    .user-count{font-size:.8rem;color:#94a3b8;font-weight:400}
    .users-container{flex:1;overflow-y:auto;overflow-x:hidden}
    
    /* Users Toggle Button */
    .users-toggle-btn{background:rgba(79,70,229,0.2);border:1px solid rgba(79,70,229,0.3);color:#e6eef8;padding:8px 12px;border-radius:8px;cursor:pointer;display:none;align-items:center;gap:6px;transition:all 0.2s;font-size:.85rem;font-weight:500;white-space:nowrap}
    .users-toggle-btn:hover{background:rgba(79,70,229,0.3)}
    .users-toggle-btn svg{width:16px;height:16px;fill:currentColor;transition:transform 0.3s;flex-shrink:0}
    .users-toggle-btn.active svg{transform:rotate(180deg)}
    
    /* User List Items */
    .user-section{padding:8px}
    .section-title{padding:8px 12px;font-size:.85rem;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:6px}
    .section-title .count{font-weight:400;font-size:.8rem}
    .section-divider{height:1px;background:rgba(255,255,255,0.06);margin:8px 12px}
    .user-item{padding:8px 12px;margin:4px 0;border-radius:8px;background:#0b1426;border:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;gap:8px}
    .user-item .user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#4f46e5,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.85rem;overflow:hidden;flex-shrink:0}
    .user-item .user-avatar img{width:100%;height:100%;object-fit:cover}
    .user-item .user-info{flex:1;display:flex;flex-direction:column;gap:2px;min-width:0}
    .user-item .name{font-size:.9rem;color:#e6eef8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .user-item .user-status{font-size:.75rem;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .user-item .dot{width:8px;height:8px;border-radius:50%;background:#94a3b8;flex-shrink:0}
    .user-item .dot.online{background:#10b981;box-shadow:0 0 8px rgba(16,185,129,0.4)}
    .empty-state{padding:20px 12px;text-align:center;color:#64748b;font-size:.85rem}
    
    /* Chat Messages */
    .status{padding:8px 12px;background:#0f172a;border-bottom:1px solid rgba(255,255,255,0.08);font-size:.85rem;color:#94a3b8;flex-shrink:0}
    .messages{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 16px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth;min-height:0}
    .msg{padding:8px 12px;border-radius:10px;background:#0b1426;border:1px solid rgba(255,255,255,0.06);max-width:70%;word-wrap:break-word}
    .msg .meta{font-size:.8rem;color:#94a3b8;margin-bottom:4px}
    .msg .body{line-height:1.4;word-break:break-word}
    .msg.me{background:linear-gradient(180deg, rgba(79,70,229,0.18), rgba(6,182,212,0.12));align-self:flex-end}
    
    /* Message header with avatar */
    .msg-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.1);flex-shrink:0}
    .username-clickable{color:#06b6d4;cursor:pointer;font-weight:600;transition:color 0.2s ease;border-radius:4px;padding:2px 4px;margin:-2px -4px}
    .username-clickable:hover{color:#0891b2;background:rgba(6,182,212,0.1);transform:translateY(-1px)}
    .username-clickable:active{transform:translateY(0)}

    /* Profile Modal Styles */
    .profile-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px;overflow:auto}
    .profile-modal.show{display:flex}
    .profile-content{background:#1e293b;border-radius:12px;width:100%;max-width:500px;max-height:90vh;overflow:auto;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
    .profile-header{padding:24px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:center}
    .profile-avatar{width:120px;height:120px;border-radius:50%;margin:0 auto 16px;background:#334155;color:#e2e8f0;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:bold;border:4px solid #475569}
    .profile-name{font-size:1.5rem;font-weight:bold;color:#f1f5f9;margin-bottom:8px}
    .profile-email{color:#94a3b8;font-size:0.9rem}
    .profile-body{padding:24px}
    .profile-field{margin-bottom:20px}
    .profile-label{color:#94a3b8;font-size:0.85rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px}
    .profile-value{color:#f1f5f9;font-size:0.95rem;line-height:1.5;background:#0f172a;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1)}
    .profile-value.empty{color:#64748b;font-style:italic}
    .profile-close{position:absolute;top:16px;right:16px;background:none;border:none;color:#94a3b8;font-size:1.5rem;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s}
    .profile-close:hover{background:rgba(255,255,255,0.1);color:#f1f5f9}
    
    /* Compose Area (Footer) */
    .compose{display:flex;gap:8px;padding:12px 16px;background:#0f172a;border-top:1px solid rgba(255,255,255,0.08);flex-shrink:0;min-height:60px}
    .compose input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0b1220;color:#fff;outline:none;min-width:0}
    .compose input:focus{border-color:rgba(79,70,229,0.5)}
    .compose button{padding:12px 20px;border-radius:10px;border:0;background:linear-gradient(90deg,#4f46e5,#06b6d4);color:#fff;font-weight:600;cursor:pointer;transition:transform 0.1s;white-space:nowrap;flex-shrink:0}
    .compose button:hover{transform:translateY(-1px)}
    .compose button:active{transform:translateY(0)}
    
    /* Attachment button */
    .attach-btn{width:44px;height:44px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:#0b1220;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.1s;flex-shrink:0}
    .attach-btn:hover{background:#1a2332;border-color:rgba(255,255,255,0.15)}
    .attach-btn.loading{opacity:0.6;cursor:not-allowed}
    
    /* Attachment preview */
    .attachment-preview{display:none;padding:8px 12px;background:#0b1426;border:1px solid rgba(255,255,255,0.08);border-radius:8px;margin:8px 0;align-items:center;gap:8px}
    .attachment-preview.show{display:flex}
    .attachment-preview .file-info{flex:1;font-size:0.85rem;color:#94a3b8}
    .attachment-preview .cancel-btn{background:none;border:none;color:#ef4444;cursor:pointer;padding:4px;font-size:14px}
    
    /* Message attachments */
    .msg-attachment{margin:8px 0;border-radius:8px;overflow:hidden;max-width:100%}
    .msg-attachment img{max-width:300px;max-height:200px;border-radius:8px;cursor:pointer}
    .msg-attachment audio{width:100%;max-width:300px}
    .msg-attachment .file-name{color:#94a3b8;font-size:0.8rem;margin-top:4px}
    
    /* Embedded media from URLs */
    .embedded-media{margin:8px 0}
    .embedded-media img{display:block;border:1px solid rgba(255,255,255,0.08)}
    
    /* File input hidden */
    #fileInput{display:none}
    
    /* Tablet Responsive (768px - 1300px) */
    @media (max-width:1300px){
      body{
        padding:10px;
        padding-top:max(10px, env(safe-area-inset-top));
        padding-bottom:max(10px, env(safe-area-inset-bottom));
      }
      .chat-container{width:calc(100vw - 20px);height:calc(100vh - 20px);max-width:1260px;max-height:none}
      .brand-title{font-size:1rem}
    }
    
    /* Mobile Responsive */
    @media (max-width:768px){
      body{
        padding:0;
        padding-top:env(safe-area-inset-top, 0px);
        padding-bottom:0; /* Remove bottom padding to prevent scrolling */
      }
      .chat-container{
        width:100vw;
        height:100vh;
        height:100dvh; /* Use dynamic viewport height for better mobile support */
        border-radius:0;
        border:none;
        max-width:none;
        max-height:none;
        position:fixed; /* Fix position to prevent scrolling issues */
        top:0;
        left:0;
      }
      
      /* Ensure chat section takes remaining space */
      .main-container{
        flex:1;
        min-height:0; /* Allow flex child to shrink */
        display:flex;
        flex-direction:row;
      }
      
      .chat-section{
        flex:1;
        min-height:0;
        display:flex;
        flex-direction:column;
      }
      
      /* Messages area should be scrollable */
      .messages{
        flex:1;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
        padding:8px 12px;
        scroll-behavior:smooth;
      }
      
      /* Compose section should stick to bottom */
      .compose{
        position:sticky;
        bottom:0;
        background:#0f172a;
        border-top:1px solid rgba(255,255,255,0.08);
        padding:12px;
        gap:8px;
        min-height:60px;
        z-index:10;
      }
      .top-safe-bar{display:block}
      .bottom-safe-bar{display:none} /* Hide bottom safe bar to prevent input issues */
      
      header{padding:10px 12px;height:auto;min-height:56px;flex-wrap:wrap;gap:8px;flex-shrink:0}
      .brand{gap:6px;flex:1;min-width:0}
      .brand a{padding:4px 8px;font-size:.85rem;gap:4px}
      .brand a span{display:none}
      .brand svg{width:16px;height:16px}
      .brand-title{font-size:.95rem;display:none}
      .header-actions{gap:8px}
      .users-toggle-btn{display:flex;font-size:.8rem;padding:8px 12px;min-height:40px;touch-action:manipulation}
      .users-toggle-btn svg{width:14px;height:14px}
      .profile-btn{width:36px;height:36px;font-size:.9rem;touch-action:manipulation}
      .sidebar{position:absolute;right:0;top:0;bottom:0;width:280px;transform:translateX(0);transition:transform 0.3s ease;z-index:100;box-shadow:-4px 0 20px rgba(0,0,0,0.5)}
      .sidebar.collapsed{transform:translateX(100%)}
      
      .compose input{padding:12px;font-size:16px;border-radius:12px;-webkit-appearance:none;appearance:none;flex:1} /* Prevents zoom on iOS */
      .compose button{padding:12px 18px;font-size:.9rem;min-height:44px;touch-action:manipulation;flex-shrink:0}
      .attach-btn{width:44px;height:44px;flex-shrink:0}
      .msg{max-width:85%;font-size:.9rem;padding:10px 12px}
      .dropdown{right:-10px;min-width:220px}
      .user-item{padding:8px 12px;min-height:48px;touch-action:manipulation}
      .user-item .user-avatar{width:32px;height:32px}
      
      /* Profile Modal Mobile */
      .profile-modal{padding:10px}
      .profile-content{max-width:none;max-height:95vh}
      .profile-header{padding:20px 16px}
      .profile-avatar{width:100px;height:100px;font-size:2rem}
      .profile-body{padding:16px}
      .profile-field{margin-bottom:16px}
    }
    
    /* Small Mobile */
    @media (max-width:480px){
      .brand a{font-size:.75rem}
      .sidebar{width:260px}
      .user-item{padding:6px 10px;min-height:44px}
      .user-item .user-avatar{width:30px;height:30px;font-size:.8rem}
      .user-item .name{font-size:.85rem}
      .user-item .user-status{font-size:.7rem}
      .compose{padding:10px;min-height:56px}
      .compose input{padding:10px 12px;font-size:16px}
      .compose button{padding:10px 14px;font-size:.85rem;min-height:40px}
      .attach-btn{width:40px;height:40px}
      .users-toggle-btn{padding:6px 10px;font-size:.75rem;min-height:36px}
      .profile-btn{width:32px;height:32px;font-size:.8rem}
      .msg{font-size:.85rem;padding:8px 10px}
    }

    /* Very small screens */
    @media (max-width: 360px) {
      .sidebar{width:240px}
      .compose{padding:8px}
      .attach-btn{width:36px;height:36px}
      .users-toggle-btn{padding:6px 8px}
    }
    
    /* Landscape Mobile */
    @media (max-height:500px){
      header{min-height:48px;padding:8px 12px}
      .compose{min-height:48px;padding:8px 12px}
      .messages{padding:8px 12px}
      .user-item{min-height:40px}
    }

    /* Touch improvements */
    @media (hover: none) and (pointer: coarse) {
      .user-item:active{background:rgba(255,255,255,0.08)}
      .compose button:active{transform:scale(0.95)}
      .users-toggle-btn:active{transform:scale(0.95)}
      .profile-btn:active{transform:scale(0.95)}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script>
    let stompClient = null;
    let currentUser = null;
    let audioContext = null;
    let isInitialLoad = true; // Flag to prevent notification on history load

    function resolveUser(){
      // First check server session (this works across tabs)
      return fetch('/api/session/me', { 
        method: 'GET', 
        credentials: 'same-origin' 
      })
      .then(response => {
        if (response.ok) {
          return response.text();
        }
        throw new Error('No server session');
      })
      .then(username => {
        if (username) {
          // Update sessionStorage to match server session
          sessionStorage.setItem('gk_user', username);
          return username;
        }
        throw new Error('Empty username');
      })
      .catch(() => {
        // Fallback to sessionStorage (for guests)
        try{
          const guest = JSON.parse(sessionStorage.getItem('gk_guest')||'null');
          if(guest && guest.username) return guest.username;
        }catch{}
        try{
          const u = sessionStorage.getItem('gk_user');
          if(u) return u;
        }catch{}
        return null;
      });
    }

    // Initialize audio context on first user interaction
    function initAudioContext(){
      if(!audioContext){
        try{
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          console.log('Audio context initialized');
        }catch(e){
          console.warn('Audio not supported:', e);
        }
      }
    }

    // Play notification sound using Web Audio API
    function playNotificationSound(){
      if(!audioContext) return;
      
      try{
        // Create a pleasant notification sound (two-tone beep)
        const oscillator1 = audioContext.createOscillator();
        const oscillator2 = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator1.connect(gainNode);
        oscillator2.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // First tone: 800Hz
        oscillator1.frequency.value = 800;
        oscillator1.type = 'sine';
        
        // Second tone: 1000Hz (harmony)
        oscillator2.frequency.value = 1000;
        oscillator2.type = 'sine';
        
        // Volume envelope (fade in/out)
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05);
        gainNode.gain.linearRampToValueAtTime(0.2, now + 0.1);
        gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
        
        oscillator1.start(now);
        oscillator1.stop(now + 0.15);
        oscillator2.start(now);
        oscillator2.stop(now + 0.15);
        
        console.log('Notification sound played');
      }catch(e){
        console.warn('Failed to play notification:', e);
      }
    }

    // Play custom MP3 notification for tag mentions
    function playTagNotification(){
      try{
        const audio = new Audio('/sounds/notification.mp3');
        audio.volume = 0.8; // Slightly louder for important tag notifications
        audio.play().then(() => {
          console.log('Tag notification sound played');
        }).catch(err => {
          console.warn('Failed to play tag notification:', err);
          // Fallback to default beep if MP3 fails
          playNotificationSound();
        });
      }catch(e){
        console.warn('Failed to create tag notification audio:', e);
        // Fallback to default beep
        playNotificationSound();
      }
    }

    // Check if message contains a tag mention for current user
    function isTaggedMessage(content, username){
      if(!content || !username) return false;
      
      // Look for @username mentions (case-insensitive)
      const mentions = content.match(/@\w+/g) || [];
      return mentions.some(mention => 
        mention.toLowerCase() === `@${username.toLowerCase()}`
      );
    }

    // Test function to check WebSocket connectivity
    function testWebSocketConnection(){
      console.log('üîß Testing WebSocket connection...');
      console.log('üîß StompClient exists:', !!stompClient);
      console.log('üîß StompClient connected:', stompClient ? stompClient.connected : 'N/A');
      console.log('üîß Current user:', currentUser);
      
      if(stompClient && stompClient.connected){
        console.log('üîß WebSocket appears to be connected. Sending test message...');
        const testPayload = {
          sender: currentUser || 'test-user',
          content: 'Test message from debug function'
        };
        try {
          stompClient.send('/app/sendMessage', {}, JSON.stringify(testPayload));
          console.log('üîß Test message sent successfully');
        } catch(error) {
          console.error('üîß Failed to send test message:', error);
        }
      } else {
        console.error('üîß WebSocket not connected!');
      }
    }

    // Make test function available globally for debugging
    window.testWebSocket = testWebSocketConnection;

    function connect(){
      setStatus('Connecting...');
      
      const socket = new SockJS('/chat');
      stompClient = Stomp.over(socket);
      // Disable debug logs for better performance
      stompClient.debug = null;
      
      stompClient.connect({}, function(frame){
        console.log('WebSocket connected');
        setStatus('Connected ‚úÖ');
        
        // Clear any reconnection attempts
        if (window.reconnectInterval) {
          clearInterval(window.reconnectInterval);
          window.reconnectInterval = null;
        }
        
        // Immediately notify server of current user to track online status
        if(currentUser){
          fetch('/api/user/online', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: currentUser})
          }).then(()=>{
            loadOnlineUsers(); // Refresh the users list once
          }).catch(err=>console.error('Failed to notify online status:', err));
        }
        
        stompClient.subscribe('/topic/messages', function(messageOutput){
          try{
            const data = JSON.parse(messageOutput.body);
            if(data && data.content){ 
              appendMessage(data, false); // false = not from history
            }
          }catch(parseError){
            // Fallback for plain strings
            appendMessage({ sender: 'system', content: messageOutput.body, timestamp: new Date().toISOString() }, false);
          }
        });
        // load history
        fetch('/api/messages/recent?limit=50',{cache:'no-store'}).then(r=>r.json()).then(list=>{
          document.getElementById('messages').innerHTML='';
          (list||[]).forEach(msg => appendMessage(msg, true)); // true = from history
          scrollToBottom();
          // Mark initial load complete after a short delay
          setTimeout(() => { isInitialLoad = false; }, 1000);
        }).catch((err)=>{ console.error('Failed to load history:', err); });
      }, function(err){
        console.error('WebSocket connection error:', err);
        setStatus('Disconnected ‚ùå - Will retry');
        
        // Auto-reconnect after 3 seconds
        setTimeout(() => {
          if (!stompClient || !stompClient.connected) {
            console.log('Attempting to reconnect...');
            connect();
          }
        }, 3000);
      });
    }

    function setStatus(text){
      const el=document.getElementById('status'); 
      if(el) {
        el.textContent=text||'';
        el.style.color = text.includes('Connected') ? '#4CAF50' : 
                         text.includes('Disconnected') ? '#f44336' : 
                         text.includes('Connecting') ? '#ff9800' : '#333';
      }
    }

    function sendMessage(){
      const input = document.getElementById('chatInput');
      const content = (input.value||'').trim();
      
      if(!content) {
        return;
      }
      
      if(!stompClient) {
        console.error('StompClient is null - reconnecting...');
        connect();
        return;
      }
      
      if(!stompClient.connected) {
        console.error('StompClient not connected - reconnecting...');
        connect();
        return;
      }
      
      const payload = { sender: currentUser || 'anonymous', content };
      
      try {
        stompClient.send('/app/sendMessage', {}, JSON.stringify(payload));
        input.value='';
      } catch (error) {
        console.error('Failed to send message via WebSocket:', error);
        // Fallback: send via REST API
        sendMessageViaRest(payload);
      }
    }
    
    function sendMessageViaRest(payload) {
      fetch('/api/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        // Manually add message to UI since WebSocket isn't working
        appendMessage(data, false);
        scrollToBottom();
        document.getElementById('chatInput').value = '';
      })
      .catch(error => {
        console.error('Failed to send message via REST API:', error);
        alert('Failed to send message. Please check your connection.');
      });
    }

    function tagUser(username) {
      const input = document.getElementById('chatInput');
      if (!input || !username) return;
      
      const currentValue = input.value;
      const tag = `@${username} `;
      
      // If input is empty, just add the tag
      if (!currentValue.trim()) {
        input.value = tag;
      } else {
        // If input has content, add tag at the end with a space
        input.value = currentValue + (currentValue.endsWith(' ') ? '' : ' ') + tag;
      }
      
      // Focus the input and place cursor at the end
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
      
      // Scroll input into view if needed
      input.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      console.log(`Tagged user: ${username}`);
    }

    function viewUserProfile(username) {
      if (!username || username.trim() === '') {
        console.log('No username provided for profile view');
        return;
      }
      
      console.log(`Loading profile for: ${username}`);
      
      // Show loading state
      const modal = document.getElementById('profileModal');
      const profileName = document.getElementById('profileName');
      const profileAvatar = document.getElementById('profileAvatar');
      const profileEmail = document.getElementById('profileEmail');
      const profileGender = document.getElementById('profileGender');
      const profileAge = document.getElementById('profileAge');
      const profileStatus = document.getElementById('profileStatus');
      const profileDescription = document.getElementById('profileDescription');
      const profileStory = document.getElementById('profileStory');
      
      if (profileName) profileName.textContent = 'Loading...';
      if (modal) modal.classList.add('show');
      
      // Fetch user profile
      fetch(`/api/user/profile/${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
          console.log('Profile data received:', data);
          
          if (data.error) {
            alert(data.error);
            closeProfileModal();
            return;
          }
          
          const profile = data.profile;
          
          // Set profile information
          if (profileName) profileName.textContent = profile.username || 'Unknown User';
          if (profileEmail) profileEmail.textContent = profile.email || 'No email provided';
          
          // Set avatar
          if (profileAvatar) {
            if (profile.profilePicture && profile.profilePicture.trim() !== '') {
              profileAvatar.innerHTML = `<img src="${profile.profilePicture}" alt="${profile.username}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
            } else {
              // Generate default avatar
              const firstLetter = (profile.username && profile.username.length > 0) ? profile.username[0].toUpperCase() : '?';
              profileAvatar.innerHTML = firstLetter;
            }
          }
          
          // Set profile fields with fallback for empty values
          if (profileGender) {
            if (profile.gender && profile.gender.trim() !== '') {
              profileGender.textContent = profile.gender;
              profileGender.classList.remove('empty');
            } else {
              profileGender.textContent = 'Not specified';
              profileGender.classList.add('empty');
            }
          }
          
          if (profileAge) {
            if (profile.age) {
              profileAge.textContent = `${profile.age} years old`;
              profileAge.classList.remove('empty');
            } else {
              profileAge.textContent = 'Not specified';
              profileAge.classList.add('empty');
            }
          }
          
          if (profileStatus) {
            if (profile.status && profile.status.trim() !== '') {
              profileStatus.textContent = profile.status;
              profileStatus.classList.remove('empty');
            } else {
              profileStatus.textContent = 'No status';
              profileStatus.classList.add('empty');
            }
          }
          
          if (profileDescription) {
            if (profile.description && profile.description.trim() !== '') {
              profileDescription.textContent = profile.description;
              profileDescription.classList.remove('empty');
            } else {
              profileDescription.textContent = 'No description provided';
              profileDescription.classList.add('empty');
            }
          }
          
          if (profileStory) {
            if (profile.story && profile.story.trim() !== '') {
              profileStory.textContent = profile.story;
              profileStory.classList.remove('empty');
            } else {
              profileStory.textContent = 'No story shared';
              profileStory.classList.add('empty');
            }
          }
        })
        .catch(error => {
          console.error('Failed to load profile:', error);
          alert('Failed to load user profile. Please try again.');
          closeProfileModal();
        });
    }

    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    // Close modal when clicking outside of it
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'profileModal') {
        closeProfileModal();
      }
    });

    function processMessageContent(content) {
      if (!content) return { hasMedia: false, html: '' };
      
      // URL regex pattern for detecting URLs
      const urlRegex = /(https?:\/\/[^\s]+)/gi;
      const urls = content.match(urlRegex) || [];
      
      if (urls.length === 0) {
        return { hasMedia: false, html: content };
      }
      
      let processedContent = content;
      let hasEmbeddedMedia = false;
      
      urls.forEach(url => {
        // Check if URL is an image or GIF
        if (isImageUrl(url)) {
          const imageHtml = `
            <div class="embedded-media">
              <img src="${url}" alt="Embedded image" onclick="openImageModal('${url}')" 
                   style="max-width: 300px; max-height: 200px; border-radius: 8px; cursor: pointer;"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <div style="display: none; color: #ef4444; font-size: 0.8rem; margin-top: 4px;">Failed to load image</div>
            </div>
          `;
          processedContent = processedContent.replace(url, imageHtml);
          hasEmbeddedMedia = true;
        } else {
          // Make other URLs clickable
          const linkHtml = `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #06b6d4; text-decoration: underline;">${url}</a>`;
          processedContent = processedContent.replace(url, linkHtml);
        }
      });
      
      return { hasMedia: hasEmbeddedMedia, html: processedContent };
    }
    
    function isImageUrl(url) {
      // Check for common image/GIF patterns
      const imageExtensions = /\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i;
      const gifDomains = [
        'tenor.com',
        'giphy.com', 
        'gfycat.com',
        'imgur.com',
        'media.discordapp.net',
        'cdn.discordapp.com'
      ];
      
      // Check file extension
      if (imageExtensions.test(url)) {
        return true;
      }
      
      // Check known GIF hosting domains
      try {
        const urlObj = new URL(url);
        if (gifDomains.some(domain => urlObj.hostname.includes(domain))) {
          return true;
        }
      } catch (e) {
        // Invalid URL, skip
      }
      
      return false;
    }

    function appendMessage(msg, isFromHistory){
      const list = document.getElementById('messages');
      if(!list) return;
      const wrap = document.createElement('div');
      const me = (currentUser && msg && msg.sender && msg.sender.toLowerCase() === currentUser.toLowerCase());
      wrap.className = 'msg' + (me ? ' me' : '');
      
      // Improved timestamp handling
      let ts;
      if (msg.timestamp) {
        // Handle different timestamp formats from backend
        if (typeof msg.timestamp === 'string') {
          // If it's a string, ensure it's properly parsed as local time
          // LocalDateTime from backend comes without timezone, treat as local time
          const timestampStr = msg.timestamp.includes('T') ? msg.timestamp : msg.timestamp + 'T00:00:00';
          ts = new Date(timestampStr);
        } else {
          ts = new Date(msg.timestamp);
        }
        
        // Validate the date
        if (isNaN(ts.getTime())) {
          console.warn('Invalid timestamp:', msg.timestamp);
          ts = new Date();
        }
      } else {
        ts = new Date();
      }
      
      // Format time consistently
      const timeText = ts.toLocaleTimeString([], {
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true  // Show AM/PM for clarity
      });
      
      // Create avatar and clickable username
      const senderName = msg.sender || 'unknown';
      const avatarUrl = msg.senderAvatar || `https://ui-avatars.com/api/?name=${senderName.charAt(0)}&background=random&size=32&rounded=true`;
      const clickableUsername = `<span class="username-clickable" onclick="tagUser('${senderName}')" oncontextmenu="viewUserProfile('${senderName}'); event.preventDefault();" title="Click to tag @${senderName} ‚Ä¢ Right-click to view profile">${senderName}</span>`;
      
      wrap.innerHTML = `
        <div class="msg-header">
          <img src="${avatarUrl}" alt="${senderName}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${senderName.charAt(0)}&background=6c757d&color=fff&size=32&rounded=true'">
          <div class="meta">${clickableUsername} ‚Ä¢ ${timeText}</div>
        </div>
        <div class="body"></div>
      `;
      
      const bodyDiv = wrap.querySelector('.body');
      
      // Process message content for URLs and GIFs
      const processedContent = processMessageContent(msg.content || '');
      if (processedContent.hasMedia) {
        bodyDiv.innerHTML = processedContent.html;
      } else {
        bodyDiv.textContent = msg.content || '';
      }
      
      // Add attachment if present
      if (msg.attachmentUrl && msg.attachmentType) {
        const attachmentDiv = document.createElement('div');
        attachmentDiv.className = 'msg-attachment';
        
        if (msg.attachmentType === 'image' || msg.attachmentType === 'gif') {
          attachmentDiv.innerHTML = `
            <img src="${msg.attachmentUrl}" alt="${msg.attachmentName || 'Image'}" onclick="openImageModal('${msg.attachmentUrl}')">
            <div class="file-name">${msg.attachmentName || 'Image'}</div>
          `;
        } else if (msg.attachmentType === 'audio') {
          attachmentDiv.innerHTML = `
            <audio controls>
              <source src="${msg.attachmentUrl}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
            <div class="file-name">${msg.attachmentName || 'Audio'}</div>
          `;
        }
        
        bodyDiv.appendChild(attachmentDiv);
      }
      
      list.appendChild(wrap);
      scrollToBottom();
      
      // Play notification sound for new messages from others (not from history, not from self)
      if(!isFromHistory && !isInitialLoad && !me && msg.sender !== 'system'){
        if(isTaggedMessage(msg.content, currentUser)){
          // Play custom MP3 for tag mentions
          playTagNotification();
        } else {
          // Play default beep for regular messages
          playNotificationSound();
        }
      }
    }

    function scrollToBottom(){
      const list = document.getElementById('messages');
      list && (list.scrollTop = list.scrollHeight);
    }

    function loadOnlineUsers(){
      fetch('/api/users/all',{cache:'no-store'})
        .then(r=>r.json())
        .then(data=>{
          const onlineContainer = document.getElementById('onlineUsersList');
          const offlineContainer = document.getElementById('offlineUsersList');
          const headerCount = document.getElementById('userCount');
          const onlineCountEl = document.getElementById('onlineCount');
          const offlineCountEl = document.getElementById('offlineCount');
          
          if(!onlineContainer || !offlineContainer) return;
          
          onlineContainer.innerHTML = '';
          offlineContainer.innerHTML = '';
          
          if(!data || !data.users || data.users.length===0){
            onlineContainer.innerHTML = '<div class="empty-state">No users online</div>';
            offlineContainer.innerHTML = '<div class="empty-state">No users registered</div>';
            if(headerCount) headerCount.textContent = '0 online';
            if(onlineCountEl) onlineCountEl.textContent = '(0)';
            if(offlineCountEl) offlineCountEl.textContent = '(0)';
            return;
          }
          
          // Separate users into online and offline
          const onlineUsers = data.users.filter(u => u.online);
          const offlineUsers = data.users.filter(u => !u.online);
          
          // Sort alphabetically within each group
          onlineUsers.sort((a, b) => a.username.localeCompare(b.username));
          offlineUsers.sort((a, b) => a.username.localeCompare(b.username));
          
          // Update counts
          if(headerCount) headerCount.textContent = onlineUsers.length + ' online';
          if(onlineCountEl) onlineCountEl.textContent = '(' + onlineUsers.length + ')';
          if(offlineCountEl) offlineCountEl.textContent = '(' + offlineUsers.length + ')';
          
          // Render online users
          if(onlineUsers.length === 0){
            onlineContainer.innerHTML = '<div class="empty-state">No users online</div>';
          } else {
            onlineUsers.forEach(user=>{
              const isCurrentUser = user.username && user.username.toLowerCase() === (currentUser||'').toLowerCase();
              const item = document.createElement('div');
              item.className = 'user-item';
              
              // Make item clickable for profile viewing (except for current user)
              if (!isCurrentUser && !user.isGuest) {
                item.style.cursor = 'pointer';
                item.title = `Click to view ${user.username}'s profile`;
                item.onclick = () => viewUserProfile(user.username);
              }
              
              const guestLabel = user.isGuest ? ' üë§' : '';
              const nameText = isCurrentUser ? user.username + ' (You)' + guestLabel : user.username + guestLabel;
              
              // Create avatar
              const avatar = document.createElement('div');
              avatar.className = 'user-avatar';
              if(user.profilePicture){
                const img = document.createElement('img');
                img.src = user.profilePicture;
                img.alt = user.username;
                avatar.appendChild(img);
              } else {
                avatar.textContent = user.username.charAt(0).toUpperCase();
              }
              
              // Create user info
              const userInfo = document.createElement('div');
              userInfo.className = 'user-info';
              const namEl = document.createElement('div');
              namEl.className = 'name';
              namEl.textContent = nameText;
              userInfo.appendChild(namEl);
              
              if(user.status && !user.isGuest){
                const statusEl = document.createElement('div');
                statusEl.className = 'user-status';
                statusEl.textContent = user.status;
                userInfo.appendChild(statusEl);
              }
              
              // Create online dot
              const dot = document.createElement('div');
              dot.className = 'dot online';
              
              item.appendChild(avatar);
              item.appendChild(userInfo);
              item.appendChild(dot);
              onlineContainer.appendChild(item);
            });
          }
          
          // Render offline users
          if(offlineUsers.length === 0){
            offlineContainer.innerHTML = '<div class="empty-state">No users offline</div>';
          } else {
            offlineUsers.forEach(user=>{
              const isCurrentUser = user.username && user.username.toLowerCase() === (currentUser||'').toLowerCase();
              const item = document.createElement('div');
              item.className = 'user-item';
              
              // Make item clickable for profile viewing (except for current user)
              if (!isCurrentUser && !user.isGuest) {
                item.style.cursor = 'pointer';
                item.title = `Click to view ${user.username}'s profile`;
                item.onclick = () => viewUserProfile(user.username);
              }
              
              const guestLabel = user.isGuest ? ' üë§' : '';
              const nameText = isCurrentUser ? user.username + ' (You)' + guestLabel : user.username + guestLabel;
              
              // Create avatar
              const avatar = document.createElement('div');
              avatar.className = 'user-avatar';
              if(user.profilePicture){
                const img = document.createElement('img');
                img.src = user.profilePicture;
                img.alt = user.username;
                avatar.appendChild(img);
              } else {
                avatar.textContent = user.username.charAt(0).toUpperCase();
              }
              
              // Create user info
              const userInfo = document.createElement('div');
              userInfo.className = 'user-info';
              const namEl = document.createElement('div');
              namEl.className = 'name';
              namEl.textContent = nameText;
              userInfo.appendChild(namEl);
              
              if(user.status && !user.isGuest){
                const statusEl = document.createElement('div');
                statusEl.className = 'user-status';
                statusEl.textContent = user.status;
                userInfo.appendChild(statusEl);
              }
              
              // Create offline dot
              const dot = document.createElement('div');
              dot.className = 'dot';
              
              item.appendChild(avatar);
              item.appendChild(userInfo);
              item.appendChild(dot);
              offlineContainer.appendChild(item);
            });
          }
        })
        .catch(err=>{
          console.error('Failed to load users:', err);
          
          // Show error state in UI
          const onlineContainer = document.getElementById('onlineUsersList');
          const offlineContainer = document.getElementById('offlineUsersList');
          const headerCount = document.getElementById('userCount');
          
          if(onlineContainer) onlineContainer.innerHTML = '<div class="empty-state">‚ö†Ô∏è Failed to load users</div>';
          if(offlineContainer) offlineContainer.innerHTML = '<div class="empty-state">Check connection</div>';
          if(headerCount) headerCount.textContent = 'Connection error';
          
          // Retry after 10 seconds instead of 5 for less aggressive retry
          setTimeout(() => {
            loadOnlineUsers();
          }, 10000);
        });
    }

    function logout(){
      // Notify server user is going offline
      if(currentUser){
        fetch('/api/user/offline', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username: currentUser})
        }).catch(()=>{});
      }
      
      // Call server to invalidate session
      fetch('/api/logout', {method:'POST'})
        .then(()=>{
          sessionStorage.removeItem('gk_user');
          sessionStorage.removeItem('gk_guest');
          if(stompClient && stompClient.connected){
            stompClient.disconnect(()=>{
              window.location.href = '/index.html';
            });
          } else {
            window.location.href = '/index.html';
          }
        })
        .catch(()=>{
          // Even if server call fails, clear client side and redirect
          sessionStorage.removeItem('gk_user');
          sessionStorage.removeItem('gk_guest');
          window.location.href = '/index.html';
        });
    }

    function loadUserProfile(){
      fetch('/api/profile', {
        method: 'GET',
        credentials: 'include'
      })
      .then(res => {
        if(!res.ok) throw new Error('Failed to load profile');
        return res.json();
      })
      .then(data => {
        if(data.profilePicture){
          const profileBtn = document.getElementById('profileBtn');
          const initialEl = document.getElementById('userInitial');
          
          // Create image element
          const img = document.createElement('img');
          img.src = data.profilePicture;
          img.alt = currentUser;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '50%';
          
          // Hide initial and show image
          initialEl.style.display = 'none';
          profileBtn.appendChild(img);
        }
      })
      .catch(err => {
        console.log('Profile picture not available or user not logged in');
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      // Handle async user resolution
      const userPromise = resolveUser();
      
      if (userPromise instanceof Promise) {
        // New async version
        userPromise.then(username => {
          currentUser = username;
          if (username) {
            initializeUserInterface(username);
            connect();
          } else {
            // No user found, redirect to login or handle as guest
            console.log('No user session found');
          }
        }).catch(err => {
          console.log('Error resolving user:', err);
        });
      } else {
        // Fallback for synchronous version
        currentUser = userPromise;
        if (currentUser) {
          initializeUserInterface(currentUser);
          connect();
        }
      }
    });
    
    function initializeUserInterface(username) {
      const nameEl = document.getElementById('dropdownUsername');
      const initialEl = document.getElementById('userInitial');
      if(username){ 
        nameEl.textContent = username; 
        initialEl.textContent = username.charAt(0).toUpperCase();
        
        // Check if user is admin and show admin panel link
        checkAdminStatus(username);
        
        // Load profile picture if user is logged in (not guest)
        try{
          const guest = JSON.parse(sessionStorage.getItem('gk_guest')||'null');
          if(!guest || !guest.username){
            // This is a registered user, load their profile
            loadUserProfile();
          }
        }catch{}
      } else {
        // prompt for a display name as fallback
        const pick = prompt('Enter a display name for chat:');
        const username = (pick||'anonymous').trim();
        sessionStorage.setItem('gk_user', username);
        const nameEl = document.getElementById('dropdownUsername');
        const initialEl = document.getElementById('userInitial');
        nameEl.textContent = username;
        initialEl.textContent = username.charAt(0).toUpperCase();
      }
    }
    
    function checkAdminStatus(username) {
      // Check if current user is admin to show admin panel link
      fetch('/api/admin/stats', { 
        method: 'GET',
        credentials: 'same-origin' 
      })
      .then(response => {
        if (response.ok) {
          // User is admin, show admin panel button
          document.getElementById('adminPanelBtn').style.display = 'block';
          console.log('Admin access detected - showing admin panel link');
        } else {
          // User is not admin, keep button hidden
          document.getElementById('adminPanelBtn').style.display = 'none';
        }
      })
      .catch(error => {
        // Error or no admin access, keep button hidden
        document.getElementById('adminPanelBtn').style.display = 'none';
      });
    }
    
    // Attachment handling
    let selectedFile = null;
    
    function handleAttachmentClick() {
      console.log('Attachment button clicked');
      document.getElementById('fileInput').click();
    }
    
    function handleFileSelect(event) {
      console.log('File input changed');
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('Selected file:', file.name, file.size, file.type);
      
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif', 
                           'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/ogg', 'audio/m4a'];
      
      if (!allowedTypes.includes(file.type)) {
        alert('Unsupported file type. Only images (JPEG, PNG, WebP), GIFs, and audio (MP3, WAV, OGG, M4A) are allowed.');
        console.log('Invalid file type:', file.type);
        return;
      }
      
      // Validate file size
      const maxSize = file.type.startsWith('audio/') ? 10 * 1024 * 1024 : 8 * 1024 * 1024; // 10MB for audio, 8MB for images
      if (file.size > maxSize) {
        alert('File too large. Max sizes: Images/GIFs: 8MB, Audio: 10MB');
        console.log('File too large:', file.size, 'max:', maxSize);
        return;
      }
      
      selectedFile = file;
      console.log('File selected successfully:', selectedFile);
      showAttachmentPreview(file);
    }
    
    function showAttachmentPreview(file) {
      const preview = document.getElementById('attachmentPreview');
      const fileInfo = document.getElementById('fileInfo');
      const fileSize = (file.size / 1024 / 1024).toFixed(2) + 'MB';
      const fileType = file.type.startsWith('audio/') ? 'üéµ Audio' : 
                      file.type === 'image/gif' ? 'üé≠ GIF' : 'üñºÔ∏è Image';
      
      fileInfo.textContent = `${fileType}: ${file.name} (${fileSize})`;
      preview.classList.add('show');
    }
    
    function cancelAttachment() {
      selectedFile = null;
      document.getElementById('attachmentPreview').classList.remove('show');
      document.getElementById('fileInput').value = '';
    }
    
    function uploadFile() {
      if (!selectedFile) {
        console.log('No file selected for upload');
        return;
      }
      
      console.log('Starting file upload:', selectedFile.name);
      
      const attachBtn = document.getElementById('attachBtn');
      attachBtn.classList.add('loading');
      
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('sender', currentUser || 'anonymous');
      
      console.log('Sending upload request to /api/upload');
      
      fetch('/api/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Upload response status:', response.status);
        return response.text();
      })
      .then(data => {
        console.log('Upload successful:', data);
        // File uploaded successfully, message will be broadcast via WebSocket
        cancelAttachment();
      })
      .catch(error => {
        console.error('Upload failed:', error);
        alert('Failed to upload file. Please try again.');
      })
      .finally(() => {
        attachBtn.classList.remove('loading');
      });
    }
    
    function openImageModal(imageUrl) {
      // Create modal for viewing full-size images
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.9); z-index: 9999; display: flex; 
        align-items: center; justify-content: center; cursor: pointer;
      `;
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
      
      modal.appendChild(img);
      document.body.appendChild(modal);
      
      modal.onclick = () => document.body.removeChild(modal);
    }
    
    // Initialize app after DOM is ready
    function initializeApp() {
      // Initialize audio context on user interaction
      document.getElementById('sendBtn').addEventListener('click', function(){
        initAudioContext();
        if (selectedFile) {
          uploadFile();
        } else {
          sendMessage();
        }
      });
      document.getElementById('chatInput').addEventListener('keydown', (e)=>{ 
        if(e.key==='Enter'){ 
          e.preventDefault(); 
          initAudioContext();
          if (selectedFile) {
            uploadFile();
          } else {
            sendMessage();
          }
        }
      });
      
      // Attachment event listeners
      document.getElementById('attachBtn').addEventListener('click', handleAttachmentClick);
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('cancelAttachment').addEventListener('click', cancelAttachment);
      
      // Mobile input focus handling
      const chatInput = document.getElementById('chatInput');
      chatInput.addEventListener('focus', function() {
        // Delay to allow virtual keyboard to appear
        setTimeout(() => {
          // Scroll to bottom to ensure input is visible
          scrollToBottom();
          // Scroll input into view
          chatInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }, 300);
      });
      
      // Prevent body scroll when input is focused on mobile
      chatInput.addEventListener('focusin', function() {
        if (window.innerWidth <= 768) {
          document.body.style.overflow = 'hidden';
        }
      });
      
      chatInput.addEventListener('focusout', function() {
        if (window.innerWidth <= 768) {
          document.body.style.overflow = '';
          setTimeout(scrollToBottom, 100);
        }
      });
      
      // Also initialize on any click
      document.body.addEventListener('click', initAudioContext, { once: true });
      
      // Load online users initially and refresh every 30 seconds (reduced frequency)
      loadOnlineUsers();
      setInterval(loadOnlineUsers, 30000);
      
      // Profile dropdown toggle
      document.getElementById('profileBtn').addEventListener('click', function(e){
        e.stopPropagation();
        document.getElementById('profileDropdown').classList.toggle('show');
      });
      
      document.addEventListener('click', function(){
        document.getElementById('profileDropdown').classList.remove('show');
      });
      
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // Users sidebar toggle
      document.getElementById('usersToggleBtn').addEventListener('click', function(){
        const sidebar = document.getElementById('usersSidebar');
        const btn = document.getElementById('usersToggleBtn');
        sidebar.classList.toggle('collapsed');
        btn.classList.toggle('active');
      });
    }
    
    // Run initialization after user is resolved
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });
  </script>
  
</head>
<body>
  <!-- Safe area bars for mobile browsers -->
  <div class="top-safe-bar"></div>
  <div class="bottom-safe-bar"></div>
  
  <div class="chat-container">
  <header>
    <div class="brand">
      <a href="/profile.html">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        <span>Profile</span>
      </a>
      <span class="brand-title">GK Tamil Chat</span>
    </div>
    <div class="header-actions">
      <button id="usersToggleBtn" class="users-toggle-btn active">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        Users
      </button>
      <div class="profile-menu">
        <div class="profile-btn" id="profileBtn">
          <span id="userInitial">U</span>
        </div>
        <div class="dropdown" id="profileDropdown">
          <div class="dropdown-header">
            <div class="username" id="dropdownUsername">User</div>
            <div class="email">Signed in</div>
          </div>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item" onclick="window.location.href='/profile.html'">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Profile
          </button>
          <button class="dropdown-item" id="adminPanelBtn" style="display:none;" onclick="window.location.href='/admin.html'">
            <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>
            üõ°Ô∏è Admin Panel
          </button>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item" id="logoutBtn">
            <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4z"/></svg>
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="main-container">
    <div class="chat-section">
      <div id="status" class="status">Connecting‚Ä¶</div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div id="attachmentPreview" class="attachment-preview">
        <div class="file-info" id="fileInfo"></div>
        <button class="cancel-btn" id="cancelAttachment" title="Cancel attachment">‚úï</button>
      </div>
      <div class="compose">
        <button class="attach-btn" id="attachBtn" title="Add attachment">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C13.1 2 14 2.9 14 4V12C14 13.1 13.1 14 12 14C10.9 14 10 13.1 10 12V4C10 2.9 10.9 2 12 2ZM21 9V11H14V9H21ZM10 9V11H3V9H10Z"/>
          </svg>
        </button>
        <input type="file" id="fileInput" accept="image/*,audio/*,.gif" />
        <input id="chatInput" type="text" placeholder="Type a message and press Enter" autocomplete="off" />
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>
    
    <div class="sidebar" id="usersSidebar">
      <div class="sidebar-header">
        <span>Users</span>
        <span class="user-count" id="userCount">Loading...</span>
      </div>
      <div class="users-container">
        <div class="user-section" id="onlineSection">
          <div class="section-title">
            <span>Online</span>
            <span class="count" id="onlineCount">(0)</span>
          </div>
          <div id="onlineUsersList">
            <div class="empty-state">No users online</div>
          </div>
        </div>
        <div class="section-divider"></div>
        <div class="user-section" id="offlineSection">
          <div class="section-title">
            <span>Offline</span>
            <span class="count" id="offlineCount">(0)</span>
          </div>
          <div id="offlineUsersList">
            <div class="empty-state">No users offline</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-content">
      <button class="profile-close" onclick="closeProfileModal()">&times;</button>
      <div class="profile-header">
        <div id="profileAvatar" class="profile-avatar"></div>
        <div id="profileName" class="profile-name"></div>
        <div id="profileEmail" class="profile-email"></div>
      </div>
      <div class="profile-body">
        <div class="profile-field">
          <div class="profile-label">Gender</div>
          <div id="profileGender" class="profile-value"></div>
        </div>
        <div class="profile-field">
          <div class="profile-label">Age</div>
          <div id="profileAge" class="profile-value"></div>
        </div>
        <div class="profile-field">
          <div class="profile-label">Status</div>
          <div id="profileStatus" class="profile-value"></div>
        </div>
        <div class="profile-field">
          <div class="profile-label">Description</div>
          <div id="profileDescription" class="profile-value"></div>
        </div>
        <div class="profile-field">
          <div class="profile-label">Story</div>
          <div id="profileStory" class="profile-value"></div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
